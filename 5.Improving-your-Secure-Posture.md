# 規制コンプライアンス
**前提事項**
この Lab を実行するには `Defender for Cloud Lab の準備` を完了している必要があります。

## 目的
本章ではセキュリティ態勢を向上させるための策をみていきます。

## VM の脆弱性評価
サーバー用のクラウド用 Microsoft Defender を使用すると、追加の構成や追加コストなしで、統合された脆弱性評価ソリューション (Qualys を使用) をすばやく展開できます。脆弱性評価スキャナーが展開されると、仮想マシンにインストールされているすべてのアプリケーションを継続的に評価して脆弱性を見つけ、その結果を Microsoft Defender for Cloud コンソールに表示します。脆弱性評価ソリューションが展開されていないマシンが見つかった場合、Microsoft Defender for Cloud は推奨事項を生成します: 仮想マシンで脆弱性評価ソリューションを有効にする必要があります。リソースを修復するには、[クイック修正] ボタンをクリックして、必要な VM 拡張機能をデプロイします。

1. Microsoft Defender for Cloud サイドバーから、[推奨事項] をクリックします。
1. 脆弱性の修復セキュリティ制御 (セキュリティの脆弱性に関連するすべての推奨事項を含む) を費やします。
1. 仮想マシンの推奨事項で脆弱性評価ソリューションを有効にする必要があることを確認します。この推奨事項が一覧にない場合は、評価で推奨事項を取得するのに 24 時間かかる可能性があります。
1. 「仮想マシンで脆弱性評価ソリューションを有効にする必要がある」の推奨事項を開く – この推奨事項は、目的の VM に VM 拡張機能をデプロイできるクイックフィックスの推奨事項です。
1. 修復手順の支出 – [クイック修正修復] オプションに加えて、[クイック修正ロジックの表示] オプションを使用して、自動修復スクリプト コンテンツ (ARM テンプレート) を公開することもできます。このウィンドウを閉じます。
1. 異常なタブから、asclab-win 仮想マシンと aslab-linux 仮想マシンの両方を選択します。[修正] をクリックします。
1. [脆弱性評価ソリューションの選択] で、 [推奨: Qualys を搭載した ASC 統合脆弱性スキャナーを展開する] を選択します (サーバー用のクラウド用 1. Microsoft Defender に含まれています)。[続行] をクリックします。
ウィンドウが開き、VM の一覧を確認して、[2 リソースの修復] ボタンをクリックします。
1. 修復は現在進行中です。Microsoft Defender for Cloud は、選択した VM に Qualys VM 拡張機能をデプロイするため、通知領域または Azure アクティビティ ログを使用して状態を追跡します。プロセスが完了するまで5〜10分待ちます。
注: サポートされているオペレーティング システムの一覧については、こちらを参照してください。

1. VM 拡張機能が関連するマシンにデプロイされていることを確認します。
    1. Azure ポータルから [仮想マシン] を開きます。
    1. asclab-winを選択します。
    1. サイドバーから、[拡張機能]をクリックします。
    1. 拡張機能がインストールされ、正常にプロビジョニングされていることを確認してください。WindowsAgent.AzureSecurityCenter
    1. asc1. lab-linux についてもこのプロセスを繰り返します – Linux プラットフォーム上の拡張機能には、LinuxAgent.AzureSecurityCenter という別の名前が表示されるはずです。
> 注: 大規模な展開で実現する必要があるプロセスを自動化する方法は複数あります。詳細については、ドキュメントとブログを参照してください。

1. ボット エージェントは必要なすべてのアーティファクトを収集して Qualys Cloud に送信し、調査結果は 24 時間以内に ASC コンソールに返されます。

脆弱性評価の結果を表示して修復します。

1. Microsoft Defender for Cloud サイドバーから、[推奨事項] をクリックします。
1. 脆弱性の修復セキュリティ制御 (セキュリティの脆弱性に関連するすべての推奨事項を含む) を費やします。
1. 仮想マシンの脆弱性の検索を修復する必要があります。
1. セキュリティチェックで、影響を受けるリソースで見つかった脆弱性のリストが表示されます。
1. 推奨事項では、影響を受けるリソースを消費します。2 つの異常なリソース (asclab-win と asclab-linux) と該当しないリソースが表示されます。
1. 異常なリソースから、asclab-win リソースを選択します。ここでは、そのリソースに関連するすべての推奨事項を表示できます。
1. 検出結果のリストから、上部にある最も高い脆弱性 (ID 376813) をクリックします。
1. 情報ペインに、説明、影響、重大度、修復手順などを含む脆弱性の詳細が表示されます。

## コンテナーの脆弱性評価
クラウド用 Microsoft Defender は、レジストリにプッシュされたイメージ、レジストリにインポートされたイメージ、または過去 30 日以内にプルされたイメージの ACR (Azure コンテナー レジストリ) をスキャンします。 次に、画像ごとに詳細な調査結果を公開します。すべての脆弱性は、次の推奨事項で見つけることができます: Azure コンテナー レジストリ イメージの脆弱性を修復する必要があります (Qualys を使用)。

脆弱性のあるコンテナー レジストリ イメージをシミュレートするには、ACR tasks コマンドとサンプル イメージを使用します。

1. Azure portal で、[コンテナー レジストリ] ブレードに移動するか、ここをクリックします。
1. 名前またはコンテナー レジストリをコピーします (例: asclabcrktfvrxcne4kki
1. bash 環境を使用して Azure クラウド シェルを開きます。
1. Microsoft コンテナー レジストリでホストされている hello-world イメージから Linux コンテナー イメージをビルドし、サブスクリプションの既存の 1. Azure コンテナー レジストリ インスタンスにプッシュします。

次の 2 つのスクリプト ブロックを実行します。
```
echo FROM mcr.microsoft.com/azuredocs/aci-helloworld > Dockerfile
```
次のスクリプトを変更して、コンテナー レジストリ名を含めます。
```
az acr build --image sample/hello-world:v1 --registry <your container registry name> --file Dockerfile .
```
1. 実行成功メッセージが表示されるまで待ちます。例: 実行 ID: cb1 は 23 秒後に成功しました
1. 通常、スキャンは数分以内に完了しますが、脆弱性/セキュリティ検出結果が推奨事項に表示されるまでに最大 15 分かかる場合があります。
1. Microsoft Defender for Cloud サイドバーから、[推奨事項] をクリックします。
1. [脆弱性の修復] セキュリティ コントロールを展開し、[コンテナー レジストリ イメージで脆弱性の検出結果が解決される必要がある] を選択します。
1. 推奨事項ページで、上部のセクションに次の詳細が表示されます。
    - 異常なレジストリ: 1/1
    - 推奨の重大度: 高
    - 脆弱性の総数: 2 つ以上の脆弱性が予想される
1. [影響を受けるリソース] セクションを費やし、1 つのコンテナー レジストリ (asclab-xxx) を示す異常なレジストリ数を確認します。
1. [セキュリティ チェック] セクションで、脆弱性の数を確認します。
1. 最初のセキュリティチェックをクリックして、右側のペインを開きます。脆弱性の説明、一般的な情報、修復、および影響を受けるリソースに注意してください。このウィンドウを閉じます。

## ワークフローの自動化を使用して推奨事項を自動化する
すべてのセキュリティプログラムには、インシデント対応のための複数のワークフローが含まれています。これらのプロセスには、関連する利害関係者への通知、変更管理プロセスの開始、特定の修復手順の適用が含まれる場合があります。 ワークフローの自動化を使用すると、ロジック アプリをトリガーして、Microsoft Defender for Cloud イベント (セキュリティ アラートまたは推奨事項) を使用してリアルタイムでプロセスを自動化できます。 このラボでは、新しいロジック アプリを作成し、特定の推奨事項に変更があった場合にワークフロー自動化機能を使用して自動的にトリガーします。

### 新しいロジック アプリを作成します。
1. Azure ポータルで、上部の検索フィールドに「ロジック アプリ」と入力するか、ここをクリックしてください。
1. [追加] をクリックして、新しいロジック アプリを作成します。
1. [基本] タブで、Azure サブスクリプション 1 とリソース グループ asclab を選択します。
1. [ロジック アプリ名] フィールドに、「SendRecommendations Changes12」などの一意の名前を入力します (注: ロジック アプリ名が一意でない場合はエラー1. が発生します)。
1. たとえば、西ヨーロッパ (前の演習で使用したのと同じリージョンを使用することをお勧めします) などの場所を選択します。
1. [計画] セクションで、[従量課金] を選択します。
1. 他のすべてのオプションはデフォルトのままにします。
1. [レビュー + 作成]、[作成] の順に選択します。
1. Logic Apps デザイナーが開き、 [空のロジック アプリ] を選択します。
1. 検索コントロールで、「クラウド用 Microsoft Defender」と入力し、[クラウド用 Microsoft Defender の推奨事項が作成またはトリガーされたとき] を選択1. します。
1. 新しいステップをクリックし、「Outlook.com」と入力します。
1. リストを下にスクロールし、[電子メールの送信 (V2)] アクションをクリックしてデザイナーに追加します。
> 注: Outlook.com (Microsoft アカウント) にサインインし、アカウントを使用してメールを送信するためのアクセス許可をロジック アプリに付与する必要が1. あります。
1. [電子メールの送信 (V2)] で、[宛先] フィールドに電子メール アドレスを追加します。
1. 後で、そのメールアドレスを使用して、ワークフロー自動化機能を使用してメールを受信したかどうかを確認します。
1. [件名] ボックスをクリックし、「推奨事項が変更されました」と入力します。
1. [推奨事項の変更:]の直後にクリックして、カーソルを適切な場所に移動します。動的コンテンツ ボックスで、[動的コンテンツ] をクリックし、 (自動的に表示1. されない場合は [動的コンテンツの追加] をクリックします) を選択します)。Properties Display Name
1. [本文] テキスト ボックスをクリックし、次のように入力します。
1. 各セクションの直後をクリックして、カーソルを適切な場所に移動します。動的コンテンツ ボックスで、[もっと見る] をクリックし、各行を次のコンテンツに一致させます。
1. ロジック アプリは次のスクリーンショットのようになります。その場合は、ロジック アプリ デザイナーで [保存] をクリックします。

### 新しいワークフロー自動化インスタンスを作成する
1. Microsoft Defender for Cloud のサイドバーから、[管理] セクションの下にある [ワークフローの自動化] を選択します。
1. [ワークフロー自動化の追加] をクリックします。
1. 右側にペインが表示されます。各フィールドに次のように入力します。
- 全般：
    -  名前: 送信-推奨事項変更
    -  説明: 推奨事項が作成またはトリガーされたときに電子メール メッセージを送信する
    -  サブスクリプション: Azure サブスクリプション 1
    -  リソース グループ: アスラブ
-  トリガー条件:
    -  クラウド データの種類の Microsoft Defender の選択: クラウドの推奨事項に対する Microsoft Defender
    -  レコメンデーション名: 選択されたすべてのレコメンデーション
    -  推奨事項の重大度: 選択されたすべての重大度
    -  推奨状態: 選択されたすべての状態
-  アクション：
    -  次のサブスクリプションのロジック アプリ インスタンスを表示します: Azure サブスクリプション 1
    -  ロジック アプリ名: 送信-推奨事項の変更 [作成] をクリックしてタスクを完了します。
1. バナーワークフローの自動化が正常に作成されたのを待ちます。変更が反映されるまでに最大 5 分かかる場合があります。今後、推奨事項の電子メール通知を受1. け取ります。 電子メール通知の受信を開始したら、ワークフローを選択して[無効にする]をクリックすることで、自動化を無効にすることができます。
> トリガーが "サブ推奨事項" または "入れ子になった推奨事項" を含む推奨事項である場合、ロジック アプリは新しいセキュリティ検出結果ごとにトリガーされ1. るわけではないことに注意してください。親のステータスが
1. 自動化が自動的にトリガーされると、電子メールメッセージは次のスクリーンショットのようになります。
1. 自動化を手動でテスト/トリガーします。
    -  Microsoft Defender for Cloud サイドバーで、[推奨事項] をクリックします。
    -  クイックフィックスバナー(推奨事項の右側にある稲妻の記号)がある推奨事項を探します。
    -  リソースを選択し、[ロジック アプリのトリガー] ボタンをクリックします。
    -  [ロジック アプリ トリガー] ブレードで、前の手順で作成したロジック アプリ ([推奨事項の変更の送信]) を選択します。
    -  以下を含むメールが届きます...
    -  Microsoft Defender for Cloud のトップ メニューから [Guides & Feedback] をクリックします。
1. ここでは、ワークフローの自動化の詳細、役立つリンクの取得、GitHubリポジトリのコミュニティツールの探索を行うことができます。
1. [コミュニティ ツール] をクリックし、[すべてのコミュニティ ツールを表示] をクリックします。

### ARG を使用してセキュリティ スコアにアクセスする
Azure Resource Graph (ARG) は、特定のサブスクリプション セットにわたって大規模なクエリを実行する機能を備えた、効率的でパフォーマンスの高いリソース探索を提供します。 Azure Secure Score データは ARG で利用できるため、セキュリティ コントロールのスコアを照会して計算し、複数のサブスクリプション間で集計されたスコアを正確に計算できます。

1. Azure ポータルから、リソース グラフ エクスプローラー (または arg) を検索します。
1. 次の KQL クエリを貼り付け、[クエリの実行] を選択します。
```
SecurityResources
| where type == 'microsoft.security/securescores'
| extend current = properties.score.current, max = todouble(properties.score.max)
| project subscriptionId, current, max, percentage = ((current / max)*100)
```
1. これで、サブスクリプション ID が現在のスコア (ポイント単位)、最大スコア、およびパーセンテージとしてのスコアと共に一覧表示されます。
1. すべてのセキュリティ コントロールの状態を返すには、[新しいクエリ] を選択し、次の KQL クエリを貼り付けて、[クエリの実行] をクリックします。
```
SecurityResources
| where type == 'microsoft.security/securescores/securescorecontrols'
| extend SecureControl = properties.displayName, unhealthy = properties.unhealthyResourceCount, currentscore = properties.score.current, maxscore = properties.score.max
| project SecureControl , unhealthy, currentscore, maxscore
```

### ガバナンス ルールの作成と所有者の割り当て
セキュリティ チームは、組織のセキュリティ体制を改善する責任がありますが、セキュリティに関する推奨事項を実際に実装するためのリソースや権限を持っていない場合があります。所有者に期日を割り当て、ガバナンス ルールを定義することで、説明責任と透明性が生まれ、組織のセキュリティ体制を改善するプロセスを推進できます。

[セキュリティ体制] ページで、作成した推奨事項の進行状況を確認します。所有者と管理者への毎週の電子メール通知により、セキュリティ体制と推奨事項を改善できる推奨事項に対してタイムリーなアクションを実行することを確認します。
1. クラウド用 Microsoft Defender ブレードに戻り、[環境設定] をクリックします。Azure で下矢印をクリックしてサブスクリプションを表示し、Azure Susbcription 1 で下矢印をクリックしてワークスペースを表示します。
1. 設定のサイドバーから、[ポリシー設定]セクションにある[ガバナンスルール]を選択します。
1. [ルールの追加]をクリックします
1. 新しいガバナンス ルールにルール名、説明、優先度、重大度順に入力し、[高]、[電子メール アドレスで所有者を設定]、[**修復期間を 14 日に設定] を選択し、両方のチェック マークを選択して、[作成] をクリックします。
1. 確認するには、[クラウドセキュリティ]の下の[セキュリティ体制]をクリックし、[所有者]を選択します


